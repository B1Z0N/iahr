<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.8.3" />
<title>iahr.run.manager API documentation</title>
<meta name="description" content="" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js" integrity="sha256-eOgo0OtLL4cdq7RdwRUiGKLX9XsIJ7nGhWEKbohmVAQ=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>iahr.run.manager</code></h1>
</header>
<section id="section-intro">
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">from telethon import events

from iahr.utils import SingletonMeta, ActionData, AccessList
from iahr.config import IahrConfig, IahrConfigError
from iahr.run.runner import Executer, Query, Routine
from iahr.run.runner import ExecutionError, CommandSyntaxError, PermissionsError, NonExistantCommandError, IgnoreError

from typing import Iterable, Union, Callable
from abc import ABC, abstractmethod
import json, os, atexit


class PrefixMismatchError(IahrConfigError):
    &#34;&#34;&#34;
        Exception to raise, when IahrConfig.PREFIXES were changed
        but session file remains with old ones
    &#34;&#34;&#34;
    def __init__(self, events: set):
        before = events
        after = set(IahrConfig.PREFIXES.values())

        msg = &#39;\n\n\tIt seems, that you\&#39;ve changed your config &#39;
        msg += &#39;\n\tand event prefixes don\&#39;t match now:\n&#39;
        msg += f&#39;\n\told ones: {before}\n\tnew ones: {after}&#39;
        msg += &#39;\n\n\tRevert changes in config or remove iahr.session file &#39;
        msg += &#39;\n\tor manually rename prefixes in it&#39;

        super().__init__(msg)

    @classmethod
    def check_events(cls, events: set):
        events = set(events)
        if events != set(IahrConfig.PREFIXES.values()):
            raise cls(events)


class ABCManager(ABC):
    &#34;&#34;&#34;
        ABC for defining custom Managers
    &#34;&#34;&#34;
    def __init__(self):
        &#34;&#34;&#34;
            Load state from file and register dumping to file
            atexit
        &#34;&#34;&#34;
        # for new message events only(commands)
        self.commands = {}
        # for all other types of events, plain handlers, can&#39;t be combined
        self.handlers = {
            prefix: {}
            for prefix in IahrConfig.REVERSE_PREFIXES.keys()
        }
        # tags for quick search
        self.tags = {}
        # for errignore on chat level
        self.chatlist = AccessList(allow_others=False)
        # state for dumping and loading from file
        self.commands_state, self.handlers_state = self.load()

        atexit.register(self.dump)

    @abstractmethod
    def add(self, command: str, handler: Callable, about: str, delimiter):
        &#34;&#34;&#34; 
            Abstract method to add command to the manager dict
        &#34;&#34;&#34;
        pass

    @abstractmethod
    async def exec(self, event, qstr=None):
        &#34;&#34;&#34; 
            Execute query string(for new message)
            Or just a handler for other event types
        &#34;&#34;&#34;
        pass

    ##################################################
    # State management
    ##################################################

    @staticmethod
    def get_state(dct):
        return {key: val.get_state() for key, val in dct.items()}

    def dump(self):
        &#34;&#34;&#34;
            Save state(commands and routines) to the file(IahrConfig.SESSION_FNAME)
        &#34;&#34;&#34;
        IahrConfig.LOGGER.info(&#39;Dumping session and exiting&#39;)
        command_dct = self.get_state(self.commands)
        handler_dct = {
            prefix: self.get_state(handlers)
            for prefix, handlers in self.handlers.items()
        }
        dct = {
            &#39;commands&#39;: command_dct,
            &#39;handlers&#39;: handler_dct,
            &#39;chatlist&#39;: self.chatlist
        }

        with open(IahrConfig.SESSION_FNAME, &#39;w+&#39;) as f:
            json.dump(dct, f, indent=4, cls=Routine.JSON_ENCODER)

    def load(self):
        &#34;&#34;&#34;
            Load state(commands and routines) from file(IahrConfig.SESSION_FNAME)
        &#34;&#34;&#34;
        fname = IahrConfig.SESSION_FNAME
        if os.path.exists(fname) and os.path.getsize(fname) &gt; 0:
            with open(fname, &#39;r&#39;) as f:
                dct = json.load(f, cls=Routine.JSON_DECODER)
                self.chatlist = dct[&#39;chatlist&#39;]
                handlers = dct[&#39;handlers&#39;]
                commands = dct[&#39;commands&#39;]

                PrefixMismatchError.check_events(handlers.keys())

                return commands, handlers
        else:
            return {}, {
                prefix: {}
                for prefix in IahrConfig.REVERSE_PREFIXES.keys()
            }

    def init_routine(self, etype, name, fun, about):
        &#34;&#34;&#34;
            Check if routine that is being added is not in state,
            if it is, set her state appropriately
        &#34;&#34;&#34;
        if etype is events.NewMessage:
            state = self.commands_state
            allow_selfact = False
        else:
            prefix = IahrConfig.PREFIXES[etype]
            state = self.handlers_state[prefix]
            allow_selfact = True
        routine = Routine(fun, about, allow_selfact=allow_selfact)
        if state := state.get(name):
            routine.set_state(state)
        return routine

    def full_name(self, etype, command):
        if etype is events.NewMessage:
            return IahrConfig.CMD.full_command(command)
        return command

    def add_routine(self, etype, name, routine):
        if etype is events.NewMessage:
            self.commands[name] = routine
        else:
            prefix = IahrConfig.PREFIXES[etype]
            self.handlers[prefix][name] = routine

    def add_tags(self, etype, tags, name, routine):
        if etype is not events.NewMessage:
            name = IahrConfig.PREFIXES[etype] + name
        for tag in tags:
            if tag in self.tags:
                self.tags[tag][name] = routine
            else:
                self.tags[tag] = {name: routine}

    ##################################################
    # Chat spam tactic management
    ##################################################

    def is_ignored_chat(self, chat: str):
        return self.chatlist.is_allowed(chat)

    def verbose_chat(self, chat: str):
        return self.chatlist.allow(chat)

    def ignore_chat(self, chat: str):
        return self.chatlist.ban(chat)

    def __repr__(self):
        return f&#39;Manager({self.commands})&#39;


class Manager(ABCManager):
    &#34;&#34;&#34;
        Contains { command_name : routine } key-value pair
        manages addition of new commands and starting it&#39;s
        execution by Executer. Only for text-based commands!

        Manages session state(basically just access rights)
    &#34;&#34;&#34;

    ##################################################
    # Routine management
    ##################################################

    def add(self, name: str, handler: Callable, about: str, etype: type,
            tags: set):
        IahrConfig.LOGGER.info(f&#39;adding handler:name={name}:etype={etype}&#39;)

        name = self.full_name(etype, name)
        routine = self.init_routine(etype, name, handler, about)

        self.add_routine(etype, name, routine)
        self.add_tags(etype, tags, name, routine)

    async def exec(self, event, qstr=None):
        action = await ActionData.from_event(event)
        is_ignored = not self.is_ignored_chat(action.chatid)
    
        if qstr is not None:
            return await self.exec_new_msg(event, qstr, action, is_ignored)
        else:
            return await self.exec_others(event, action, is_ignored)

    async def exec_new_msg(self, event, qstr, action: ActionData, is_ignored):
        IahrConfig.LOGGER.info(f&#39;executing query:qstr={qstr}&#39;)

        runner = Executer(qstr, self.commands, action, is_ignored)
        return await runner.run()

    async def exec_others(self, event, action: ActionData, is_ignored):
        etype = type(event)._event_name.split(&#39;.&#39;)[0]
        IahrConfig.LOGGER.info(f&#39;executing handler:etype={etype}&#39;)

        prefix = IahrConfig.PREFIXES[getattr(events, etype)]
        handlers = self.handlers[prefix]

        for handler, routine in handlers.items():
            handler = routine.get_handler(action.uid, action.chatid)
            if handler is None:
                continue

            sender = await handler(event)
            await sender.send()</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="iahr.run.manager.ABCManager"><code class="flex name class">
<span>class <span class="ident">ABCManager</span></span>
</code></dt>
<dd>
<div class="desc"><p>ABC for defining custom Managers</p>
<p>Load state from file and register dumping to file
atexit</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class ABCManager(ABC):
    &#34;&#34;&#34;
        ABC for defining custom Managers
    &#34;&#34;&#34;
    def __init__(self):
        &#34;&#34;&#34;
            Load state from file and register dumping to file
            atexit
        &#34;&#34;&#34;
        # for new message events only(commands)
        self.commands = {}
        # for all other types of events, plain handlers, can&#39;t be combined
        self.handlers = {
            prefix: {}
            for prefix in IahrConfig.REVERSE_PREFIXES.keys()
        }
        # tags for quick search
        self.tags = {}
        # for errignore on chat level
        self.chatlist = AccessList(allow_others=False)
        # state for dumping and loading from file
        self.commands_state, self.handlers_state = self.load()

        atexit.register(self.dump)

    @abstractmethod
    def add(self, command: str, handler: Callable, about: str, delimiter):
        &#34;&#34;&#34; 
            Abstract method to add command to the manager dict
        &#34;&#34;&#34;
        pass

    @abstractmethod
    async def exec(self, event, qstr=None):
        &#34;&#34;&#34; 
            Execute query string(for new message)
            Or just a handler for other event types
        &#34;&#34;&#34;
        pass

    ##################################################
    # State management
    ##################################################

    @staticmethod
    def get_state(dct):
        return {key: val.get_state() for key, val in dct.items()}

    def dump(self):
        &#34;&#34;&#34;
            Save state(commands and routines) to the file(IahrConfig.SESSION_FNAME)
        &#34;&#34;&#34;
        IahrConfig.LOGGER.info(&#39;Dumping session and exiting&#39;)
        command_dct = self.get_state(self.commands)
        handler_dct = {
            prefix: self.get_state(handlers)
            for prefix, handlers in self.handlers.items()
        }
        dct = {
            &#39;commands&#39;: command_dct,
            &#39;handlers&#39;: handler_dct,
            &#39;chatlist&#39;: self.chatlist
        }

        with open(IahrConfig.SESSION_FNAME, &#39;w+&#39;) as f:
            json.dump(dct, f, indent=4, cls=Routine.JSON_ENCODER)

    def load(self):
        &#34;&#34;&#34;
            Load state(commands and routines) from file(IahrConfig.SESSION_FNAME)
        &#34;&#34;&#34;
        fname = IahrConfig.SESSION_FNAME
        if os.path.exists(fname) and os.path.getsize(fname) &gt; 0:
            with open(fname, &#39;r&#39;) as f:
                dct = json.load(f, cls=Routine.JSON_DECODER)
                self.chatlist = dct[&#39;chatlist&#39;]
                handlers = dct[&#39;handlers&#39;]
                commands = dct[&#39;commands&#39;]

                PrefixMismatchError.check_events(handlers.keys())

                return commands, handlers
        else:
            return {}, {
                prefix: {}
                for prefix in IahrConfig.REVERSE_PREFIXES.keys()
            }

    def init_routine(self, etype, name, fun, about):
        &#34;&#34;&#34;
            Check if routine that is being added is not in state,
            if it is, set her state appropriately
        &#34;&#34;&#34;
        if etype is events.NewMessage:
            state = self.commands_state
            allow_selfact = False
        else:
            prefix = IahrConfig.PREFIXES[etype]
            state = self.handlers_state[prefix]
            allow_selfact = True
        routine = Routine(fun, about, allow_selfact=allow_selfact)
        if state := state.get(name):
            routine.set_state(state)
        return routine

    def full_name(self, etype, command):
        if etype is events.NewMessage:
            return IahrConfig.CMD.full_command(command)
        return command

    def add_routine(self, etype, name, routine):
        if etype is events.NewMessage:
            self.commands[name] = routine
        else:
            prefix = IahrConfig.PREFIXES[etype]
            self.handlers[prefix][name] = routine

    def add_tags(self, etype, tags, name, routine):
        if etype is not events.NewMessage:
            name = IahrConfig.PREFIXES[etype] + name
        for tag in tags:
            if tag in self.tags:
                self.tags[tag][name] = routine
            else:
                self.tags[tag] = {name: routine}

    ##################################################
    # Chat spam tactic management
    ##################################################

    def is_ignored_chat(self, chat: str):
        return self.chatlist.is_allowed(chat)

    def verbose_chat(self, chat: str):
        return self.chatlist.allow(chat)

    def ignore_chat(self, chat: str):
        return self.chatlist.ban(chat)

    def __repr__(self):
        return f&#39;Manager({self.commands})&#39;</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li>abc.ABC</li>
</ul>
<h3>Subclasses</h3>
<ul class="hlist">
<li><a title="iahr.run.manager.Manager" href="#iahr.run.manager.Manager">Manager</a></li>
</ul>
<h3>Static methods</h3>
<dl>
<dt id="iahr.run.manager.ABCManager.get_state"><code class="name flex">
<span>def <span class="ident">get_state</span></span>(<span>dct)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@staticmethod
def get_state(dct):
    return {key: val.get_state() for key, val in dct.items()}</code></pre>
</details>
</dd>
</dl>
<h3>Methods</h3>
<dl>
<dt id="iahr.run.manager.ABCManager.add"><code class="name flex">
<span>def <span class="ident">add</span></span>(<span>self, command: str, handler: Callable, about: str, delimiter)</span>
</code></dt>
<dd>
<div class="desc"><p>Abstract method to add command to the manager dict</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@abstractmethod
def add(self, command: str, handler: Callable, about: str, delimiter):
    &#34;&#34;&#34; 
        Abstract method to add command to the manager dict
    &#34;&#34;&#34;
    pass</code></pre>
</details>
</dd>
<dt id="iahr.run.manager.ABCManager.add_routine"><code class="name flex">
<span>def <span class="ident">add_routine</span></span>(<span>self, etype, name, routine)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def add_routine(self, etype, name, routine):
    if etype is events.NewMessage:
        self.commands[name] = routine
    else:
        prefix = IahrConfig.PREFIXES[etype]
        self.handlers[prefix][name] = routine</code></pre>
</details>
</dd>
<dt id="iahr.run.manager.ABCManager.add_tags"><code class="name flex">
<span>def <span class="ident">add_tags</span></span>(<span>self, etype, tags, name, routine)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def add_tags(self, etype, tags, name, routine):
    if etype is not events.NewMessage:
        name = IahrConfig.PREFIXES[etype] + name
    for tag in tags:
        if tag in self.tags:
            self.tags[tag][name] = routine
        else:
            self.tags[tag] = {name: routine}</code></pre>
</details>
</dd>
<dt id="iahr.run.manager.ABCManager.dump"><code class="name flex">
<span>def <span class="ident">dump</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Save state(commands and routines) to the file(IahrConfig.SESSION_FNAME)</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def dump(self):
    &#34;&#34;&#34;
        Save state(commands and routines) to the file(IahrConfig.SESSION_FNAME)
    &#34;&#34;&#34;
    IahrConfig.LOGGER.info(&#39;Dumping session and exiting&#39;)
    command_dct = self.get_state(self.commands)
    handler_dct = {
        prefix: self.get_state(handlers)
        for prefix, handlers in self.handlers.items()
    }
    dct = {
        &#39;commands&#39;: command_dct,
        &#39;handlers&#39;: handler_dct,
        &#39;chatlist&#39;: self.chatlist
    }

    with open(IahrConfig.SESSION_FNAME, &#39;w+&#39;) as f:
        json.dump(dct, f, indent=4, cls=Routine.JSON_ENCODER)</code></pre>
</details>
</dd>
<dt id="iahr.run.manager.ABCManager.exec"><code class="name flex">
<span>async def <span class="ident">exec</span></span>(<span>self, event, qstr=None)</span>
</code></dt>
<dd>
<div class="desc"><p>Execute query string(for new message)
Or just a handler for other event types</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@abstractmethod
async def exec(self, event, qstr=None):
    &#34;&#34;&#34; 
        Execute query string(for new message)
        Or just a handler for other event types
    &#34;&#34;&#34;
    pass</code></pre>
</details>
</dd>
<dt id="iahr.run.manager.ABCManager.full_name"><code class="name flex">
<span>def <span class="ident">full_name</span></span>(<span>self, etype, command)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def full_name(self, etype, command):
    if etype is events.NewMessage:
        return IahrConfig.CMD.full_command(command)
    return command</code></pre>
</details>
</dd>
<dt id="iahr.run.manager.ABCManager.ignore_chat"><code class="name flex">
<span>def <span class="ident">ignore_chat</span></span>(<span>self, chat: str)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def ignore_chat(self, chat: str):
    return self.chatlist.ban(chat)</code></pre>
</details>
</dd>
<dt id="iahr.run.manager.ABCManager.init_routine"><code class="name flex">
<span>def <span class="ident">init_routine</span></span>(<span>self, etype, name, fun, about)</span>
</code></dt>
<dd>
<div class="desc"><p>Check if routine that is being added is not in state,
if it is, set her state appropriately</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def init_routine(self, etype, name, fun, about):
    &#34;&#34;&#34;
        Check if routine that is being added is not in state,
        if it is, set her state appropriately
    &#34;&#34;&#34;
    if etype is events.NewMessage:
        state = self.commands_state
        allow_selfact = False
    else:
        prefix = IahrConfig.PREFIXES[etype]
        state = self.handlers_state[prefix]
        allow_selfact = True
    routine = Routine(fun, about, allow_selfact=allow_selfact)
    if state := state.get(name):
        routine.set_state(state)
    return routine</code></pre>
</details>
</dd>
<dt id="iahr.run.manager.ABCManager.is_ignored_chat"><code class="name flex">
<span>def <span class="ident">is_ignored_chat</span></span>(<span>self, chat: str)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def is_ignored_chat(self, chat: str):
    return self.chatlist.is_allowed(chat)</code></pre>
</details>
</dd>
<dt id="iahr.run.manager.ABCManager.load"><code class="name flex">
<span>def <span class="ident">load</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Load state(commands and routines) from file(IahrConfig.SESSION_FNAME)</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def load(self):
    &#34;&#34;&#34;
        Load state(commands and routines) from file(IahrConfig.SESSION_FNAME)
    &#34;&#34;&#34;
    fname = IahrConfig.SESSION_FNAME
    if os.path.exists(fname) and os.path.getsize(fname) &gt; 0:
        with open(fname, &#39;r&#39;) as f:
            dct = json.load(f, cls=Routine.JSON_DECODER)
            self.chatlist = dct[&#39;chatlist&#39;]
            handlers = dct[&#39;handlers&#39;]
            commands = dct[&#39;commands&#39;]

            PrefixMismatchError.check_events(handlers.keys())

            return commands, handlers
    else:
        return {}, {
            prefix: {}
            for prefix in IahrConfig.REVERSE_PREFIXES.keys()
        }</code></pre>
</details>
</dd>
<dt id="iahr.run.manager.ABCManager.verbose_chat"><code class="name flex">
<span>def <span class="ident">verbose_chat</span></span>(<span>self, chat: str)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def verbose_chat(self, chat: str):
    return self.chatlist.allow(chat)</code></pre>
</details>
</dd>
</dl>
</dd>
<dt id="iahr.run.manager.Manager"><code class="flex name class">
<span>class <span class="ident">Manager</span></span>
</code></dt>
<dd>
<div class="desc"><p>Contains { command_name : routine } key-value pair
manages addition of new commands and starting it's
execution by Executer. Only for text-based commands!</p>
<p>Manages session state(basically just access rights)</p>
<p>Load state from file and register dumping to file
atexit</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class Manager(ABCManager):
    &#34;&#34;&#34;
        Contains { command_name : routine } key-value pair
        manages addition of new commands and starting it&#39;s
        execution by Executer. Only for text-based commands!

        Manages session state(basically just access rights)
    &#34;&#34;&#34;

    ##################################################
    # Routine management
    ##################################################

    def add(self, name: str, handler: Callable, about: str, etype: type,
            tags: set):
        IahrConfig.LOGGER.info(f&#39;adding handler:name={name}:etype={etype}&#39;)

        name = self.full_name(etype, name)
        routine = self.init_routine(etype, name, handler, about)

        self.add_routine(etype, name, routine)
        self.add_tags(etype, tags, name, routine)

    async def exec(self, event, qstr=None):
        action = await ActionData.from_event(event)
        is_ignored = not self.is_ignored_chat(action.chatid)
    
        if qstr is not None:
            return await self.exec_new_msg(event, qstr, action, is_ignored)
        else:
            return await self.exec_others(event, action, is_ignored)

    async def exec_new_msg(self, event, qstr, action: ActionData, is_ignored):
        IahrConfig.LOGGER.info(f&#39;executing query:qstr={qstr}&#39;)

        runner = Executer(qstr, self.commands, action, is_ignored)
        return await runner.run()

    async def exec_others(self, event, action: ActionData, is_ignored):
        etype = type(event)._event_name.split(&#39;.&#39;)[0]
        IahrConfig.LOGGER.info(f&#39;executing handler:etype={etype}&#39;)

        prefix = IahrConfig.PREFIXES[getattr(events, etype)]
        handlers = self.handlers[prefix]

        for handler, routine in handlers.items():
            handler = routine.get_handler(action.uid, action.chatid)
            if handler is None:
                continue

            sender = await handler(event)
            await sender.send()</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="iahr.run.manager.ABCManager" href="#iahr.run.manager.ABCManager">ABCManager</a></li>
<li>abc.ABC</li>
</ul>
<h3>Methods</h3>
<dl>
<dt id="iahr.run.manager.Manager.exec_new_msg"><code class="name flex">
<span>async def <span class="ident">exec_new_msg</span></span>(<span>self, event, qstr, action: <a title="iahr.utils.ActionData" href="../utils.html#iahr.utils.ActionData">ActionData</a>, is_ignored)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">async def exec_new_msg(self, event, qstr, action: ActionData, is_ignored):
    IahrConfig.LOGGER.info(f&#39;executing query:qstr={qstr}&#39;)

    runner = Executer(qstr, self.commands, action, is_ignored)
    return await runner.run()</code></pre>
</details>
</dd>
<dt id="iahr.run.manager.Manager.exec_others"><code class="name flex">
<span>async def <span class="ident">exec_others</span></span>(<span>self, event, action: <a title="iahr.utils.ActionData" href="../utils.html#iahr.utils.ActionData">ActionData</a>, is_ignored)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">async def exec_others(self, event, action: ActionData, is_ignored):
    etype = type(event)._event_name.split(&#39;.&#39;)[0]
    IahrConfig.LOGGER.info(f&#39;executing handler:etype={etype}&#39;)

    prefix = IahrConfig.PREFIXES[getattr(events, etype)]
    handlers = self.handlers[prefix]

    for handler, routine in handlers.items():
        handler = routine.get_handler(action.uid, action.chatid)
        if handler is None:
            continue

        sender = await handler(event)
        await sender.send()</code></pre>
</details>
</dd>
</dl>
<h3>Inherited members</h3>
<ul class="hlist">
<li><code><b><a title="iahr.run.manager.ABCManager" href="#iahr.run.manager.ABCManager">ABCManager</a></b></code>:
<ul class="hlist">
<li><code><a title="iahr.run.manager.ABCManager.add" href="#iahr.run.manager.ABCManager.add">add</a></code></li>
<li><code><a title="iahr.run.manager.ABCManager.dump" href="#iahr.run.manager.ABCManager.dump">dump</a></code></li>
<li><code><a title="iahr.run.manager.ABCManager.exec" href="#iahr.run.manager.ABCManager.exec">exec</a></code></li>
<li><code><a title="iahr.run.manager.ABCManager.init_routine" href="#iahr.run.manager.ABCManager.init_routine">init_routine</a></code></li>
<li><code><a title="iahr.run.manager.ABCManager.load" href="#iahr.run.manager.ABCManager.load">load</a></code></li>
</ul>
</li>
</ul>
</dd>
<dt id="iahr.run.manager.PrefixMismatchError"><code class="flex name class">
<span>class <span class="ident">PrefixMismatchError</span></span>
<span>(</span><span>events: set)</span>
</code></dt>
<dd>
<div class="desc"><p>Exception to raise, when IahrConfig.PREFIXES were changed
but session file remains with old ones</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class PrefixMismatchError(IahrConfigError):
    &#34;&#34;&#34;
        Exception to raise, when IahrConfig.PREFIXES were changed
        but session file remains with old ones
    &#34;&#34;&#34;
    def __init__(self, events: set):
        before = events
        after = set(IahrConfig.PREFIXES.values())

        msg = &#39;\n\n\tIt seems, that you\&#39;ve changed your config &#39;
        msg += &#39;\n\tand event prefixes don\&#39;t match now:\n&#39;
        msg += f&#39;\n\told ones: {before}\n\tnew ones: {after}&#39;
        msg += &#39;\n\n\tRevert changes in config or remove iahr.session file &#39;
        msg += &#39;\n\tor manually rename prefixes in it&#39;

        super().__init__(msg)

    @classmethod
    def check_events(cls, events: set):
        events = set(events)
        if events != set(IahrConfig.PREFIXES.values()):
            raise cls(events)</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="iahr.config.IahrConfigError" href="../config.html#iahr.config.IahrConfigError">IahrConfigError</a></li>
<li>builtins.RuntimeError</li>
<li>builtins.Exception</li>
<li>builtins.BaseException</li>
</ul>
<h3>Static methods</h3>
<dl>
<dt id="iahr.run.manager.PrefixMismatchError.check_events"><code class="name flex">
<span>def <span class="ident">check_events</span></span>(<span>events: set)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@classmethod
def check_events(cls, events: set):
    events = set(events)
    if events != set(IahrConfig.PREFIXES.values()):
        raise cls(events)</code></pre>
</details>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="iahr.run" href="index.html">iahr.run</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="iahr.run.manager.ABCManager" href="#iahr.run.manager.ABCManager">ABCManager</a></code></h4>
<ul class="two-column">
<li><code><a title="iahr.run.manager.ABCManager.add" href="#iahr.run.manager.ABCManager.add">add</a></code></li>
<li><code><a title="iahr.run.manager.ABCManager.add_routine" href="#iahr.run.manager.ABCManager.add_routine">add_routine</a></code></li>
<li><code><a title="iahr.run.manager.ABCManager.add_tags" href="#iahr.run.manager.ABCManager.add_tags">add_tags</a></code></li>
<li><code><a title="iahr.run.manager.ABCManager.dump" href="#iahr.run.manager.ABCManager.dump">dump</a></code></li>
<li><code><a title="iahr.run.manager.ABCManager.exec" href="#iahr.run.manager.ABCManager.exec">exec</a></code></li>
<li><code><a title="iahr.run.manager.ABCManager.full_name" href="#iahr.run.manager.ABCManager.full_name">full_name</a></code></li>
<li><code><a title="iahr.run.manager.ABCManager.get_state" href="#iahr.run.manager.ABCManager.get_state">get_state</a></code></li>
<li><code><a title="iahr.run.manager.ABCManager.ignore_chat" href="#iahr.run.manager.ABCManager.ignore_chat">ignore_chat</a></code></li>
<li><code><a title="iahr.run.manager.ABCManager.init_routine" href="#iahr.run.manager.ABCManager.init_routine">init_routine</a></code></li>
<li><code><a title="iahr.run.manager.ABCManager.is_ignored_chat" href="#iahr.run.manager.ABCManager.is_ignored_chat">is_ignored_chat</a></code></li>
<li><code><a title="iahr.run.manager.ABCManager.load" href="#iahr.run.manager.ABCManager.load">load</a></code></li>
<li><code><a title="iahr.run.manager.ABCManager.verbose_chat" href="#iahr.run.manager.ABCManager.verbose_chat">verbose_chat</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="iahr.run.manager.Manager" href="#iahr.run.manager.Manager">Manager</a></code></h4>
<ul class="">
<li><code><a title="iahr.run.manager.Manager.exec_new_msg" href="#iahr.run.manager.Manager.exec_new_msg">exec_new_msg</a></code></li>
<li><code><a title="iahr.run.manager.Manager.exec_others" href="#iahr.run.manager.Manager.exec_others">exec_others</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="iahr.run.manager.PrefixMismatchError" href="#iahr.run.manager.PrefixMismatchError">PrefixMismatchError</a></code></h4>
<ul class="">
<li><code><a title="iahr.run.manager.PrefixMismatchError.check_events" href="#iahr.run.manager.PrefixMismatchError.check_events">check_events</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.8.3</a>.</p>
</footer>
</body>
</html>